<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenList Token è·å–å·¥å…·</title>
    <link href="https://jsd.tencent.to/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://jsd.tencent.to/npm/sweetalert2@11.22.0/dist/sweetalert2.all.min.js"></script>
    <style>
        :root {
            --bg-color-light: #ffffff;
            --text-color-light: #000000;
            --bg-color-dark: #1e1e2f;
            --text-color-dark: #f0f0f0;
            --accent-color: #00d1b2;
        }

        [data-theme="light"] body {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }

        [data-theme="dark"] body {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        .form-container {
            max-width: 800px;
            margin: 3rem auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            background: inherit;
            backdrop-filter: blur(10px);
        }

        label {
            font-weight: 600;
        }

        .form-control:read-only {
            background-color: #f5f5f5;
            cursor: pointer;
        }

        .toggle-theme {
            position: fixed;
            top: 1rem;
            right: 1rem;
        }

        a {
            text-decoration: none;
        }

        [data-theme="dark"] body {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        [data-theme="dark"] .form-control {
            background-color: #2a2a3b;
            color: #f0f0f0;
            border-color: #444;
        }

        [data-theme="dark"] .form-control:read-only {
            background-color: #2a2a3b;
            color: #ccc;
            border-color: #444;
        }

        [data-theme="dark"] .form-select {
            background-color: #2a2a3b;
            color: #f0f0f0;
            border-color: #444;
        }

        [data-theme="dark"] .btn {
            background-color: #00bfa5;
            color: #ffffff;
            border: none;
        }

        [data-theme="dark"] .btn:hover {
            background-color: #00a58e;
            color: #ffffff;
        }

        [data-theme="dark"] p {
            color: #ffffff;
        }

        /* é˜¿é‡Œäº‘ç›˜æ‰«ç v2æ ·å¼ */
        .qr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .qr-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        [data-theme="dark"] .qr-modal-content {
            background-color: #2a2a3b;
            color: #f0f0f0;
        }

        .qr-code-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        [data-theme="dark"] .qr-code-container {
            background: #1a1a2e;
        }

        .qr-code-img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
        }

        .qr-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: 500;
        }

        .qr-status.waiting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .qr-status.scaned {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .qr-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .qr-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        [data-theme="dark"] .qr-status.waiting {
            background: #3d3d00;
            color: #ffeb3b;
            border: 1px solid #ffeb3b;
        }

        [data-theme="dark"] .qr-status.scaned {
            background: #003d4d;
            color: #00bcd4;
            border: 1px solid #00bcd4;
        }

        [data-theme="dark"] .qr-status.success {
            background: #1b5e20;
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        [data-theme="dark"] .qr-status.error {
            background: #5d1a1a;
            color: #f44336;
            border: 1px solid #f44336;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: black;
        }

        [data-theme="dark"] .close-btn:hover {
            color: white;
        }
    </style>
</head>
<body>
<div class="toggle-theme">
    <button class="btn btn-outline-secondary" onclick="toggleTheme()">åˆ‡æ¢ä¸»é¢˜</button>
</div>
<div class="container form-container">
    <h2 class="text-center mb-4">ğŸ” OpenList Token è·å–å·¥å…·</h2>
    <div class="mb-3">
        <label for="site-select" class="form-label">ç½‘ç›˜åç§°</label>
        <select id="site-select" class="form-select">
            <!--            <option value="onedrive_pr" selected>OneDrive ä¸ªäººè´¦æˆ·</option>-->
            <option value="onedrive_go" selected>OneDrive ä¼ä¸šç‰ˆæœ¬</option>
            <option value="onedrive_cn">OneDrive ä¸–çºªäº’è”</option>
            <option value="onedrive_us">OneDrive ç¾å›½ç‰ˆæœ¬</option>
            <option value="onedrive_de">OneDrive å¾·å›½ç‰ˆæœ¬</option>
            <option value="alicloud_qr">é˜¿é‡Œç½‘ç›˜ æ‰«ç ç™»å½•</option>
            <option value="alicloud_qr2">é˜¿é‡Œäº‘ç›˜ æ‰«ç ç™»å½•v2</option>
            <option value="baiduyun_go">ç™¾åº¦ç½‘ç›˜ éªŒè¯ç™»å½•</option>
            <option value="115cloud_go">115 ç½‘ç›˜ éªŒè¯ç™»å½•</option>
            <option value="123cloud_go">123 ç½‘ç›˜ ç›´æ¥ç™»å½•</option>
            <option value="googleui_go">Google Drive Team</option>
            <option value="yandex_go">Yandex Drive</option>
        </select>
    </div>

    <div class="mb-3" style="margin-top: 15px">
        <input type="checkbox" id="server_use" class="form-check-input">
        <label for="server_use" class="form-check-label">ä½¿ç”¨ OpenList æä¾›çš„å‚æ•°</label>
    </div>

    <div class="mb-3" id="client-id-view">
        <label for="client-id" class="form-label">Client IDï¼ˆå®¢æˆ·ç«¯IDï¼‰</label>
        <input type="text" id="client-id" class="form-control">
    </div>

    <div class="mb-3">
        <label for="app-secret" class="form-label">AppKeyï¼ˆåº”ç”¨ç§˜é’¥ï¼‰</label>
        <input type="text" id="app-secret" class="form-control">
    </div>

    <div class="mb-3" id="secret-key-view">
        <label for="secret-key" class="form-label">SecretKeyï¼ˆè®¿é—®ç§˜é’¥ï¼‰</label>
        <input type="text" id="secret-key" class="form-control">
    </div>

    <div class="mb-3">
        <label for="callback-url" class="form-label">å›è°ƒåœ°å€</label>
        <input type="text" id="callback-url" class="form-control" value="https://api.oplist.org/onedrive/callback"
               readonly
               onclick="autoCopy(this)">
    </div>

    <div class="d-grid gap-2 mb-3">
        <button class="btn btn-primary" onclick="getLogin()">è·å– Token</button>
    </div>

    <div class="mb-3">
        <label for="access-token" class="form-label">è®¿é—®ç§˜é’¥</label>
        <textarea id="access-token" class="form-control" rows="3" readonly onclick="autoCopy(this)"></textarea>
    </div>

    <div class="mb-3">
        <label for="refresh-token" class="form-label">åˆ·æ–°ç§˜é’¥</label>
        <textarea id="refresh-token" class="form-control" rows="3" readonly onclick="autoCopy(this)"></textarea>
    </div>
    <div class="mb-3">
        <label for="sharepoint-url" class="form-label">SharePoint Site URL</label>
        <label for="sharepoint-url"></label><input type="text" id="sharepoint-url" class="form-control">
    </div>
    <div class="d-grid gap-2 mb-3">
        <button class="btn btn-primary" onclick="getSiteID()">è·å– SharePoint ç«™ç‚¹ID</button>
    </div>
    <div class="mb-3">
        <label for="sharepoint-id" class="form-label">SharePoint Site URL</label>
        <textarea id="sharepoint-id" class="form-control" rows="3" readonly onclick="autoCopy(this)"></textarea>
    </div>
    <div class="text-muted text-center">
        <p style="text-align:center">
            æœ¬å·¥å…·æ‰€æœ‰ä¿¡æ¯åªä»¥Cookieå½¢å¼å­˜å‚¨äºæµè§ˆå™¨æœ¬åœ°<br>
            å¼€æºäº <a href="https://github.com/OpenListTeam/cf-worker-api" target="_blank">GitHub</a> | By <a
                href="https://github.com/OpenListTeam"
                target="_blank">OpenListTeam</a>
        </p>
    </div>
</div>


<!-- é˜¿é‡Œäº‘ç›˜æ‰«ç v2æ¨¡æ€æ¡† -->
<div id="qr-modal" class="qr-modal">
    <div class="qr-modal-content">
        <span class="close-btn" onclick="closeQRModal()">&times;</span>
        <h4>é˜¿é‡Œäº‘ç›˜æ‰«ç ç™»å½•v2</h4>
        <div id="qr-code-container" class="qr-code-container" style="display: none;">
            <div id="qr-code-display"></div>
        </div>
        <div id="qr-status" class="qr-status" style="display: none;"></div>
        <div class="mt-3">
            <button id="refresh-qr-btn" class="btn btn-secondary" onclick="refreshQRCode()" style="display: none;">åˆ·æ–°äºŒç»´ç </button>
            <button class="btn btn-secondary" onclick="closeQRModal()">å…³é—­</button>
        </div>
    </div>
</div>


<script>
    let intervalId;

    // è·å–ç™»å½•ç§˜é’¥ #######################################################
    async function getLogin() {
        let server_use = document.getElementById("server_use").checked;
        let apps_uuid = document.getElementById("client-id").value;
        let apps_keys = document.getElementById("app-secret").value;
        let apps_type = document.getElementById("site-select").value;
        let secret_key = document.getElementById("secret-key").value;
        console.log(server_use);
        // é˜¿é‡Œäº‘ç›˜æ‰«ç ç™»å½•v2ä¸éœ€è¦éªŒè¯å®¢æˆ·ç«¯IDå’Œåº”ç”¨æœºå¯†
        if (apps_type !== "alicloud_qr2" && !server_use && (apps_uuid === "" || apps_keys === "")) {
            Swal.fire({
                position: 'top',
                icon: 'info',
                title: 'è·å–å¤±è´¥',
                text: 'è¯·å…ˆå¡«å†™AppIDå’ŒAppKey',
                showConfirmButton: true,
            });
            return;
        }
        // é˜¿é‡Œäº‘ç›˜æ‰«ç v2ç›´æ¥è°ƒç”¨ä¸“ç”¨APIï¼Œä¸éœ€è¦æ„å»ºä¼ ç»Ÿçš„requestsè·¯å¾„
        if (apps_type === "alicloud_qr2") {
            await startAlicloud2Login();
            return;
        }
        
        let apps_subs = apps_type.split("_")[0]
        let post_urls = "/" + apps_subs + "/requests?client_uid=" + apps_uuid
            + "&client_key=" + apps_keys + "&apps_types=" + apps_type
            + "&server_use=" + server_use
        if (apps_subs === "baiduyun") post_urls += "&secret_key=" + secret_key
        try {
            const response = await fetch(post_urls, {
                method: 'GET', headers: {'Content-Type': 'application/json'}
            });
            // è§£æå“åº”å†…å®¹ ===============================================
            const response_data = await response.json();
            if (response.status === 200) {
                if (apps_subs === "onedrive" || apps_subs === "115cloud"
                    || apps_subs === "baiduyun" || apps_subs === "googleui" || apps_subs === "yandex") {
                    window.location.href = response_data.text;
                }
                if (apps_subs === "123cloud") {
                    document.getElementById("access-token").value = response_data.text;
                    return;
                }
                if (apps_type === "alicloud_qr") {
                    let sid = response_data.sid;
                    await Swal.fire({
                        position: 'top',
                        icon: 'info',
                        title: 'æ‰«ç ç™»å½•',
                        html: `<div>è¯·æ‰«ç ç™»å½•ï¼Œå®Œæˆåç‚¹ç¡®å®š</div>` +
                            `<img src="${response_data.text}" alt="">`,
                        showConfirmButton: true
                    });
                    post_urls = "/alicloud/callback" +
                        "?client_id=" + apps_uuid +
                        "&client_secret=" + apps_keys +
                        "&grant_type=" + "authorization_code" +
                        "&code=" + sid
                    let auth_post = await fetch(post_urls, {method: 'GET'});
                    let auth_data = await auth_post.json();
                    if (auth_post.status === 200) {
                        window.location.href = `/?access_token=${auth_data.access_token}`
                            + `&refresh_token=${auth_data.refresh_token}`
                            + `&client_uid=${apps_uuid}`
                            + `&client_key=${apps_keys}`;
                    }
                }

            } else Swal.fire({
                icon: 'error',
                title: "è·å–ç§˜é’¥å¤±è´¥: " + response_data.text,
                showConfirmButton: true,
                timer: 1000
            });
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'è·å–ç§˜é’¥å¤±è´¥: ' + error,
                showConfirmButton: true,
                timer: 1000
            });
        }
    }

    // è‡ªåŠ¨å¤åˆ¶å†…å®¹ #####################################################
    function autoCopy(on_element) {
        // if (on_element.innerText === "") return;
        navigator.clipboard.writeText(on_element.value).then(() => {
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤º
            Swal.fire({
                position: 'top',
                icon: 'success',
                title: 'å†…å®¹å·²å¤åˆ¶',
                showConfirmButton: false,
                timer: 700
            });
        }).catch(err => {
            // å¤åˆ¶å¤±è´¥æ—¶çš„å¤„ç†
            console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬ï¼š', err);
            Swal.fire({
                position: 'top',
                icon: 'error',
                title: 'å¤åˆ¶å¤±è´¥',
                text: 'è¯·æ‰‹åŠ¨å¤åˆ¶',
                showConfirmButton: true,
            });
        })
    }

    async function getToken() {
        const strSearch = window.location.search;
        const urlParams = new URLSearchParams(strSearch);
        const server_use = urlParams.get("server_use");
        const client_uid = urlParams.get("client_uid");
        const secret_key = urlParams.get("secret_key");
        const driver_txt = urlParams.get("driver_txt");
        const client_key = urlParams.get("client_key");
        const access_token = urlParams.get("access_token");
        const refresh_token = urlParams.get("refresh_token");
        const message_err = urlParams.get("message_err");
        document.getElementById("site-select").value = driver_txt;
        if (!driver_txt || driver_txt === "")
            document.getElementById("site-select").value = "onedrive_go";
        document.getElementById("app-secret").value = client_key;
        document.getElementById("client-id").value = client_uid;
        document.getElementById("access-token").value = access_token;
        document.getElementById("refresh-token").value = refresh_token;
        if (secret_key)
            document.getElementById("secret-key").value = secret_key;
        // è·å–selectå…ƒç´ å’Œè¾“å…¥æ¡†å…ƒç´ 
        const siteSelect = document.getElementById('site-select');
        const callbackUrlInput = document.getElementById('callback-url');

        // ç›‘å¬selectçš„å˜åŒ–
        siteSelect.addEventListener('change', function () {
            const selectedValue = this.value.split("_")[0]; // è·å–é€‰ä¸­çš„value
            // æ›´æ–°è¾“å…¥æ¡†çš„å€¼
            callbackUrlInput.value = `https://api.oplist.org/${selectedValue}/callback`;
            document.getElementById('secret-key-view').hidden = true;
            
            const clientIdInput = document.getElementById('client-id');
            const appSecretInput = document.getElementById('app-secret');
            const serverUseCheckbox = document.getElementById('server_use');
            const clientIdContainer = clientIdInput.closest('.mb-3');
            const appSecretContainer = appSecretInput.closest('.mb-3');
            const serverUseContainer = serverUseCheckbox.closest('.mb-3');
            const callbackContainer = callbackUrlInput.closest('.mb-3');
            
            // é˜¿é‡Œäº‘ç›˜æ‰«ç ç™»å½•v2ä¸éœ€è¦å®¢æˆ·ç«¯IDã€åº”ç”¨æœºå¯†å’Œå›è°ƒåœ°å€
            if (siteSelect.value === "alicloud_qr2") {
                // éšè—æ•´ä¸ªå­—æ®µå®¹å™¨
                clientIdContainer.style.display = 'none';
                appSecretContainer.style.display = 'none';
                serverUseContainer.style.display = 'none';
                callbackContainer.style.display = 'none';
                
                // æ¸…ç©ºå€¼
                clientIdInput.value = '';
                appSecretInput.value = '';
                serverUseCheckbox.checked = false;
            } else {
                // æ¢å¤æ˜¾ç¤º
                clientIdContainer.style.display = 'block';
                appSecretContainer.style.display = 'block';
                serverUseContainer.style.display = 'block';
                callbackContainer.style.display = 'block';
                
                // æ¢å¤æ­£å¸¸çŠ¶æ€
                if (!serverUseCheckbox.checked) {
                    clientIdInput.disabled = false;
                    appSecretInput.disabled = false;
                }
                clientIdInput.placeholder = '';
                appSecretInput.placeholder = '';
                serverUseCheckbox.disabled = false;
            }
            
            if (siteSelect.value === "baiduyun_go") {
                document.getElementById('secret-key-view').hidden = false;
                document.getElementById('client-id-view').hidden = true;
            }else{
                document.getElementById('client-id-view').hidden = false;
            }

        });
        document.getElementById('server_use').addEventListener('change', function () {
            const clientIdInput = document.getElementById('client-id');
            const appSecretInput = document.getElementById('app-secret');
            const secretKeyInput = document.getElementById('secret-key');
            const server_flag = document.getElementById('server_use');
            if ((siteSelect.value === "alicloud_qr"
                || siteSelect.value === "alicloud_qr2"
                || siteSelect.value === "123cloud_go"
                || siteSelect.value === "onedrive_cn"
                || siteSelect.value === "onedrive_us"
                || siteSelect.value === "onedrive_de"
            ) && server_flag.checked) {
                server_flag.checked = false;
                Swal.fire({
                    position: 'top',
                    icon: 'error',
                    title: 'æš‚ä¸æ”¯æŒ',
                    html: "é˜¿é‡Œäº‘ã€123äº‘ç›˜ã€OneDriveéç¾å›½åŒºåŸŸæš‚ä¸æ”¯æŒä½¿ç”¨å®˜æ–¹å¯†é’¥",
                    showConfirmButton: true,
                });
                return;
            }
            if (this.checked) {
                // ç¦ç”¨è¾“å…¥æ¡†å¹¶æ¸…ç©ºå†…å®¹
                clientIdInput.disabled = true;
                clientIdInput.value = '';
                appSecretInput.disabled = true;
                appSecretInput.value = '';
                secretKeyInput.disabled = true;
                secretKeyInput.value = '';
            } else {
                // å¯ç”¨è¾“å…¥æ¡†
                clientIdInput.disabled = false;
                appSecretInput.disabled = false;
                secretKeyInput.disabled = false;
            }
        });
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å›è°ƒåœ°å€
        window.onload = function () {
            siteSelect.dispatchEvent(new Event('change'));

        };

        if (message_err) {
            Swal.fire({
                position: 'top',
                icon: 'error',
                title: 'æˆæƒå¤±è´¥',
                html: message_err,
                showConfirmButton: true,
            });
        }
    }


    // è·å–ç«™ç‚¹ID
    function getSiteID() {
        const siteUrl = document.getElementById("sharepoint-url").value.trim();
        const access_token = document.getElementById("access-token").value.trim();
        const refresh_token = document.getElementById("refresh-token").value.trim();
        const client_uid = document.getElementById("client-id").value.trim();
        const client_key = document.getElementById("app-secret").value.trim();
        const site_type = document.getElementById("site-select").value;
        const idElement = document.getElementById("sharepoint-id");

        // å®šä¹‰ç«™ç‚¹çš„API Endpoint
        const GATEWAYS = {
            "onedrive_go": "https://graph.microsoft.com/v1.0/sites/",
            "onedrive_cn": "https://microsoftgraph.chinacloudapi.cn/v1.0/sites/",
            "onedrive_us": "https://graph.microsoft.us/v1.0/sites/",
            "onedrive_de": "https://graph.microsoft.de/v1.0/sites/"
        };

        // å®šä¹‰é”™è¯¯ä¿¡æ¯
        const ERROR_MESSAGES = {
            MISSING_CREDENTIALS: "è¯·å…ˆå¡«å†™å®¢æˆ·ç«¯IDå’Œåº”ç”¨æœºå¯†",
            MISSING_TOKENS: "è¯·è·å–Token",
            MISSING_URL: "è¯·å¡«å†™æ‚¨çš„SharePoint URL",
            NOT_SUPPORTED: "ä»…æ”¯æŒOneDriveç›¸å…³API",
            NOT_FOUND: "ç«™ç‚¹ä¸å­˜åœ¨",
            BAD_REQUEST: "è·å–å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æƒé™å’Œç«™ç‚¹URLï¼Œç«™ç‚¹URLç¤ºä¾‹ï¼šhttps://demo.sharepoint.com/site/demo",
            DEFAULT: "è¯·æ±‚å‘ç”Ÿé”™è¯¯"
        };

        // éªŒè¯
        if (!client_uid || !client_key) {
            idElement.value = ERROR_MESSAGES.MISSING_CREDENTIALS;
            return;
        }
        if (!access_token || !refresh_token) {
            idElement.value = ERROR_MESSAGES.MISSING_TOKENS;
            return;
        }
        if (!siteUrl) {
            idElement.value = ERROR_MESSAGES.MISSING_URL;
            return;
        }
        if (!site_type.includes("onedrive")) {
            idElement.value = ERROR_MESSAGES.NOT_SUPPORTED;
            return;
        }
        if (!GATEWAYS[site_type]) {
            idElement.value = ERROR_MESSAGES.DEFAULT;
            return;
        }

        // è·å–ID
        try {
            const urlParts = siteUrl.replace("https://", "").split("/");
            const site_hostname = urlParts[0];
            const site_sub_path = urlParts[1];
            const site_name = urlParts[2];
            const site_path = site_sub_path + "/" +site_name;
            const reqUrl = `${GATEWAYS[site_type]}${site_hostname}:/${site_path}`;
            const headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
                "Authorization": `Bearer ${access_token}`
            };

            fetch(reqUrl, {
                method: "GET",
                headers: headers
            })
                .then(async (res) => {
                    if (!res.ok) {
                        if (res.status === 404) {
                            idElement.value = ERROR_MESSAGES.NOT_FOUND;
                            return;
                        } else if (res.status === 400) {
                            idElement.value = ERROR_MESSAGES.BAD_REQUEST;
                            return;
                        } else {
                            idElement.value = `${ERROR_MESSAGES.DEFAULT} (HTTP ${res.status})`;
                            return;
                        }
                    }

                    try {
                        const result = await res.json();
                        if (result.id) {
                            idElement.value = result.id;
                        } else if (result.error) {
                            idElement.value = result.error.message || ERROR_MESSAGES.DEFAULT;
                        } else {
                            idElement.value = ERROR_MESSAGES.DEFAULT;
                        }
                    } catch (error) {
                        idElement.value = ERROR_MESSAGES.DEFAULT;
                        console.error("å¤„ç†å“åº”æ—¶å‡ºé”™:", error);
                    }
                })
                .catch((error) => {
                    idElement.value = ERROR_MESSAGES.BAD_REQUEST;
                    console.error("è¯·æ±‚å¤±è´¥:", error);
                });
        } catch (error) {
            idElement.value = ERROR_MESSAGES.BAD_REQUEST;
            console.error("URLè§£æå¤±è´¥:", error);
        }
    }
    //æ‰‹åŠ¨åˆ‡æ¢ä¸»é¢˜æ¨¡å¼
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-theme");
        html.setAttribute("data-theme", current === "dark" ? "light" : "dark");
    }

    // è‡ªåŠ¨åˆ‡æ¢æš—é»‘æ¨¡å¼
    (function () {
        const hour = new Date().getHours();
        if (hour < 6 || hour >= 18) document.documentElement.setAttribute("data-theme", "dark");
        getToken();
    })();

    getToken();

    // é˜¿é‡Œäº‘ç›˜æ‰«ç v2ç›¸å…³å˜é‡
    let alicloud2SessionId = null;
    let alicloud2CheckInterval = null;
    let alicloud2StartTime = null;
    let clientFingerprint = null;

    // ç”Ÿæˆå®¢æˆ·ç«¯æŒ‡çº¹
    function generateClientFingerprint() {
        if (clientFingerprint) return clientFingerprint;
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Client fingerprint', 2, 2);
        
        const fingerprint = [
            navigator.userAgent,
            navigator.language,
            screen.width + 'x' + screen.height,
            new Date().getTimezoneOffset(),
            canvas.toDataURL(),
            navigator.hardwareConcurrency || 'unknown',
            navigator.deviceMemory || 'unknown'
        ].join('|');
        
        // ç”Ÿæˆç®€å•çš„å“ˆå¸Œ
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
            const char = fingerprint.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        
        clientFingerprint = Math.abs(hash).toString(36);
        console.log('å®¢æˆ·ç«¯æŒ‡çº¹ç”Ÿæˆ:', clientFingerprint);
        return clientFingerprint;
    }

    // å‘é€å¸¦æœ‰å®¢æˆ·ç«¯æŒ‡çº¹çš„è¯·æ±‚
    async function fetchWithFingerprint(url, options = {}) {
        const fingerprint = generateClientFingerprint();
        const headers = {
            'X-Client-Fingerprint': fingerprint,
            ...options.headers
        };
        
        return fetch(url, {
            ...options,
            headers
        });
    }

    // å¯åŠ¨é˜¿é‡Œäº‘ç›˜æ‰«ç v2ç™»å½•
    async function startAlicloud2Login() {
        try {
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('qr-modal').style.display = 'block';
            setQRStatus('æ­£åœ¨ç”ŸæˆäºŒç»´ç ...', 'waiting');

            // ç”ŸæˆäºŒç»´ç  - ä½¿ç”¨å¸¦æŒ‡çº¹çš„è¯·æ±‚
            const response = await fetchWithFingerprint('/alicloud2/generate_qr');
            const result = await response.json();

            if (result.success) {
                alicloud2SessionId = result.session_id;
                alicloud2StartTime = Date.now();
                showQRCode(result.qr_code_url);
                setQRStatus('è¯·ä½¿ç”¨é˜¿é‡Œäº‘ç›˜Appæ‰«æäºŒç»´ç ', 'waiting');
                
                // æ˜¾ç¤ºè¿‡æœŸæ—¶é—´ä¿¡æ¯
                if (result.expires_in) {
                    const expireMinutes = Math.floor(result.expires_in / 60);
                    console.log(`ä¼šè¯å°†åœ¨ ${expireMinutes} åˆ†é’Ÿåè¿‡æœŸ`);
                }
                
                startStatusCheck();
            } else {
                setQRStatus(result.error || 'ç”ŸæˆäºŒç»´ç å¤±è´¥', 'error');
                document.getElementById('refresh-qr-btn').style.display = 'inline-block';
            }
        } catch (error) {
            setQRStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            document.getElementById('refresh-qr-btn').style.display = 'inline-block';
            console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
        }
    }

    // æ˜¾ç¤ºäºŒç»´ç 
    function showQRCode(qrUrl) {
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrUrl)}`;
        document.getElementById('qr-code-display').innerHTML = `<img src="${qrApiUrl}" alt="äºŒç»´ç " class="qr-code-img">`;
        document.getElementById('qr-code-container').style.display = 'block';
    }

    // è®¾ç½®çŠ¶æ€
    function setQRStatus(message, type) {
        const statusEl = document.getElementById('qr-status');
        statusEl.textContent = message;
        statusEl.className = `qr-status ${type}`;
        statusEl.style.display = 'block';
    }

    // å¼€å§‹çŠ¶æ€æ£€æŸ¥
    function startStatusCheck() {
        stopStatusCheck();
        alicloud2CheckInterval = setInterval(checkAlicloud2Status, 2000);
    }

    // åœæ­¢çŠ¶æ€æ£€æŸ¥
    function stopStatusCheck() {
        if (alicloud2CheckInterval) {
            clearInterval(alicloud2CheckInterval);
            alicloud2CheckInterval = null;
        }
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkAlicloud2Status() {
        if (!alicloud2SessionId) return;

        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡3åˆ†é’Ÿï¼ˆäºŒç»´ç å¯èƒ½è¿‡æœŸï¼‰
        const elapsed = Date.now() - alicloud2StartTime;
        if (elapsed > 180000) { // 3åˆ†é’Ÿ
            setQRStatus('äºŒç»´ç å¯èƒ½å·²è¿‡æœŸï¼Œå»ºè®®ç‚¹å‡»åˆ·æ–°é‡æ–°ç”Ÿæˆ', 'error');
            document.getElementById('refresh-qr-btn').style.display = 'inline-block';
            stopStatusCheck();
            return;
        }

        try {
            // ä½¿ç”¨å¸¦æŒ‡çº¹çš„è¯·æ±‚
            const response = await fetchWithFingerprint(`/alicloud2/check_login?session_id=${alicloud2SessionId}`);
            const result = await response.json();

            if (result.success) {
                switch (result.status) {
                    case 'WAITING':
                        const waitTime = Math.floor(elapsed / 1000);
                        setQRStatus(`ç­‰å¾…æ‰«æ... (${waitTime}s) è¯·ä½¿ç”¨é˜¿é‡Œäº‘ç›˜Appæ‰«ç `, 'waiting');
                        break;
                    case 'SCANED':
                        setQRStatus('å·²æ‰«æï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•', 'scaned');
                        break;
                    case 'CONFIRMED':
                        setQRStatus('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...', 'success');
                        stopStatusCheck();
                        // ç¨ç­‰ä¸€ä¸‹ç¡®ä¿tokenå·²ä¿å­˜
                        setTimeout(async () => {
                            await getAlicloud2UserInfo();
                        }, 1000);
                        break;
                    case 'EXPIRED':
                        setQRStatus('äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·ç‚¹å‡»åˆ·æ–°é‡æ–°ç”Ÿæˆ', 'error');
                        stopStatusCheck();
                        document.getElementById('refresh-qr-btn').style.display = 'inline-block';
                        break;
                }
            } else {
                // å¤„ç†ä¼šè¯éªŒè¯å¤±è´¥çš„æƒ…å†µ
                if (response.status === 403) {
                    setQRStatus('ä¼šè¯éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç”ŸæˆäºŒç»´ç ', 'error');
                    document.getElementById('refresh-qr-btn').style.display = 'inline-block';
                    stopStatusCheck();
                } else {
                    setQRStatus('æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    document.getElementById('refresh-qr-btn').style.display = 'inline-block';
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            setQRStatus('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
            document.getElementById('refresh-qr-btn').style.display = 'inline-block';
        }
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯
    async function getAlicloud2UserInfo() {
        if (!alicloud2SessionId) return;

        try {
            // ä½¿ç”¨å¸¦æŒ‡çº¹çš„è¯·æ±‚
            const response = await fetchWithFingerprint(`/alicloud2/get_user_info?session_id=${alicloud2SessionId}`);
            const result = await response.json();

            if (result.success && result.user_info) {
                // å…³é—­æ¨¡æ€æ¡†
                closeQRModal();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                await Swal.fire({
                    position: 'top',
                    icon: 'success',
                    title: 'ç™»å½•æˆåŠŸ',
                    html: `<div>ç”¨æˆ·: ${result.user_info.nick_name || result.user_info.user_id}</div>`,
                    showConfirmButton: true
                });

                // å¡«å……tokenå­—æ®µï¼ˆä½¿ç”¨çœŸå®çš„tokensï¼‰
                if (result.access_token) {
                    document.getElementById("access-token").value = result.access_token;
                }
                if (result.refresh_token) {
                    document.getElementById("refresh-token").value = result.refresh_token;
                }
                
                // æ¸…ç†ä¼šè¯
                await fetchWithFingerprint(`/alicloud2/logout?session_id=${alicloud2SessionId}`);
                alicloud2SessionId = null;
            } else {
                // å¤„ç†ä¼šè¯éªŒè¯å¤±è´¥çš„æƒ…å†µ
                if (response.status === 403) {
                    setQRStatus('ä¼šè¯éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                } else {
                    setQRStatus('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            }
        } catch (error) {
            setQRStatus('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        }
    }

    // åˆ·æ–°äºŒç»´ç 
    async function refreshQRCode() {
        document.getElementById('refresh-qr-btn').style.display = 'none';
        // æ¸…ç†æ—§ä¼šè¯
        if (alicloud2SessionId) {
            try {
                await fetchWithFingerprint(`/alicloud2/logout?session_id=${alicloud2SessionId}`);
            } catch (e) {
                console.log('æ¸…ç†æ—§ä¼šè¯å¤±è´¥:', e);
            }
            alicloud2SessionId = null;
        }
        await startAlicloud2Login();
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeQRModal() {
        document.getElementById('qr-modal').style.display = 'none';
        stopStatusCheck();
        
        // æ¸…ç†ä¼šè¯
        if (alicloud2SessionId) {
            fetchWithFingerprint(`/alicloud2/logout?session_id=${alicloud2SessionId}`);
            alicloud2SessionId = null;
        }
        
        // é‡ç½®ç•Œé¢
        document.getElementById('qr-code-container').style.display = 'none';
        document.getElementById('qr-status').style.display = 'none';
        document.getElementById('refresh-qr-btn').style.display = 'none';
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('qr-modal');
        if (event.target === modal) {
            closeQRModal();
        }
    }
</script>
</body>
</html>
