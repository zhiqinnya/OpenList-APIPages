
<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenList Token è·å–å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --bg-color-light: #ffffff;
            --text-color-light: #000000;
            --bg-color-dark: #1e1e2f;
            --text-color-dark: #f0f0f0;
            --accent-color: #00d1b2;
        }

        [data-theme="light"] body {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }

        [data-theme="dark"] body {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        .form-container {
            max-width: 800px;
            margin: 3rem auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            background: inherit;
            backdrop-filter: blur(10px);
        }

        label {
            font-weight: 600;
        }

        .form-control:read-only {
            background-color: #f5f5f5;
            cursor: pointer;
        }

        .toggle-theme {
            position: fixed;
            top: 1rem;
            right: 1rem;
        }

        a {
            text-decoration: none;
        }
        
        [data-theme="dark"] body {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        [data-theme="dark"] .form-control {
            background-color: #2a2a3b;
            color: #f0f0f0;
            border-color: #444;
        }

        [data-theme="dark"] .form-control:read-only {
            background-color: #2a2a3b;
            color: #ccc;
            border-color: #444;
        }

        [data-theme="dark"] .form-select {
            background-color: #2a2a3b;
            color: #f0f0f0;
            border-color: #444;
        }

        [data-theme="dark"] .btn {
            background-color: #00bfa5;
            color: #ffffff;
            border: none;
        }

        [data-theme="dark"] .btn:hover {
            background-color: #00a58e;
            color: #ffffff;
        }
        
        [data-theme="dark"] p {
            color: #ffffff;
        }
    </style>
</head>
<body>
<div class="toggle-theme">
    <button class="btn btn-outline-secondary" onclick="toggleTheme()">åˆ‡æ¢ä¸»é¢˜</button>
</div>
<div class="container form-container">
    <h2 class="text-center mb-4">ğŸ” OpenList Token è·å–å·¥å…·</h2>
    <div class="mb-3">
        <label for="site-select" class="form-label">ç½‘ç›˜åç§°</label>
        <select id="site-select" class="form-select">
            <option value="onedrive_go" selected>OneDrive å®˜æ–¹ç«™ç‚¹</option>
            <option value="onedrive_cn">OneDrive ä¸–çºªäº’è”</option>
            <option value="onedrive_us">OneDrive ç¾å›½ç‰ˆæœ¬</option>
            <option value="onedrive_de">OneDrive å¾·å›½ç‰ˆæœ¬</option>
        </select>

        <div class="mb-3">
            <label for="client-id" class="form-label">å®¢æˆ·ç«¯ ID</label>
            <input type="text" id="client-id" class="form-control">
        </div>

        <div class="mb-3">
            <label for="app-secret" class="form-label">åº”ç”¨æœºå¯†</label>
            <input type="text" id="app-secret" class="form-control">
        </div>

        <div class="mb-3">
            <label for="callback-url" class="form-label">å›è°ƒåœ°å€</label>
            <input type="text" id="callback-url" class="form-control" value="https://api.oplist.org/onedrive/callback"
                   readonly
                   onclick="autoCopy(this)">
        </div>

        <div class="d-grid gap-2 mb-3">
            <button class="btn btn-primary" onclick="getLogin()">è·å– Token</button>
        </div>

        <div class="mb-3">
            <label for="access-token" class="form-label">è®¿é—®ç§˜é’¥</label>
            <textarea id="access-token" class="form-control" rows="3" readonly onclick="autoCopy(this)"></textarea>
        </div>

        <div class="mb-3">
            <label for="refresh-token" class="form-label">åˆ·æ–°ç§˜é’¥</label>
            <textarea id="refresh-token" class="form-control" rows="3" readonly onclick="autoCopy(this)"></textarea>
        </div>

        <div class="text-muted text-center">
            <p style="text-align:center">
                æœ¬å·¥å…·æ‰€æœ‰ä¿¡æ¯åªä»¥Cookieå½¢å¼å­˜å‚¨äºæµè§ˆå™¨æœ¬åœ°<br>
                å¼€æºäº <a href="https://github.com/OpenListTeam/cf-worker-api" target="_blank">GitHub</a> | By <a
                    href="https://github.com/OpenListTeam"
                    target="_blank">OpenListTeam</a>
            </p>
        </div>
    </div>
</div>

<script>
    let intervalId;

    // è·å–ç™»å½•ç§˜é’¥ #######################################################
    async function getLogin() {
        let apps_uuid = document.getElementById("client-id").value;
        let apps_keys = document.getElementById("app-secret").value;
        let apps_type = document.getElementById("site-select").value;
        if (apps_uuid === "" || apps_keys === "") {
            Swal.fire({
                position: 'top',
                icon: 'info',
                title: 'è·å–å¤±è´¥',
                text: 'è¯·å…ˆå¡«å†™å®¢æˆ·ç«¯IDå’Œåº”ç”¨æœºå¯†',
                showConfirmButton: true,
            });
            return;
        }
        let post_urls = "/onedrive/requests?client_uid=" + apps_uuid
            + "&client_key=" + apps_keys + "&apps_type=" + apps_type;
        try {
            const response = await fetch(post_urls, {
                method: 'GET', headers: {'Content-Type': 'application/json'}
            });
            // è§£æå“åº”å†…å®¹ ===============================================
            const response_data = await response.json();
            if (response.status === 200) {
                window.location.href = response_data.text;
            } else Swal.fire({
                icon: 'error',
                title: "è·å–ç§˜é’¥å¤±è´¥: " + response_data.text,
                showConfirmButton: true,
                timer: 1000
            });
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'è·å–ç§˜é’¥å¤±è´¥: ' + error,
                showConfirmButton: true,
                timer: 1000
            });
        }
    }

    // è‡ªåŠ¨å¤åˆ¶å†…å®¹ #####################################################
    function autoCopy(on_element) {
        // if (on_element.innerText === "") return;
        navigator.clipboard.writeText(on_element.value).then(() => {
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤º
            Swal.fire({
                position: 'top',
                icon: 'success',
                title: 'å†…å®¹å·²å¤åˆ¶',
                showConfirmButton: false,
                timer: 700
            });
        }).catch(err => {
            // å¤åˆ¶å¤±è´¥æ—¶çš„å¤„ç†
            console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬ï¼š', err);
            Swal.fire({
                position: 'top',
                icon: 'error',
                title: 'å¤åˆ¶å¤±è´¥',
                text: 'è¯·æ‰‹åŠ¨å¤åˆ¶',
                showConfirmButton: true,
            });
        })
    }

    async function getToken() {
        const strSearch = window.location.search;
        const urlParams = new URLSearchParams(strSearch);
        const client_uid = urlParams.get("client_uid");
        const client_key = urlParams.get("client_key");
        const access_token = urlParams.get("access_token");
        const refresh_token = urlParams.get("refresh_token");
        const message_err = urlParams.get("message_err");
        if (message_err && client_uid) {
            Swal.fire({
                position: 'top',
                icon: 'error',
                title: 'æˆæƒå¤±è´¥',
                text: message_err,
                showConfirmButton: true,
            });
        }
        document.getElementById("client-id").value = client_uid;
        document.getElementById("app-secret").value = client_key;
        document.getElementById("access-token").value = access_token;
        document.getElementById("refresh-token").value = refresh_token;
    }

    getToken();

    //æ‰‹åŠ¨åˆ‡æ¢ä¸»é¢˜æ¨¡å¼
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-theme");
        html.setAttribute("data-theme", current === "dark" ? "light" : "dark");
    }

    // è‡ªåŠ¨åˆ‡æ¢æš—é»‘æ¨¡å¼
    (function () {
        const hour = new Date().getHours();
        if (hour < 6 || hour >= 18) document.documentElement.setAttribute("data-theme", "dark");
        getToken();
    })();
</script>
</body>
</html>
